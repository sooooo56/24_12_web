<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{global/layout}">

<div layout:fragment="content">
    <div class="container mt-5">
        <h2 class="text-center mb-4">결제 성공</h2>
        
        <div class="card">
            <div class="card-body">
                <h3>주문 정보</h3>
                <div th:if="${order != null}">
                    <p>주문 상품: <span th:text="${order.item.name}"></span></p>
                    <p>주문 수량: <span th:text="${order.quantity}"></span></p>
                    <p>배송 주소: <span th:text="${order.deliveryAddress}"></span></p>
                    <p>연락처: <span th:text="${order.phoneNumber}"></span></p>
                    <p>결제 금액: <span th:text="${amount}"></span>원</p>
                    <p>주문 번호: <span th:text="${orderId}"></span></p>
                </div>
            </div>
        </div>

        <div class="text-center mt-4">
            <a href="/main" class="btn btn-primary">메인으로 돌아가기</a>
        </div>
    </div>

    <script th:inline="javascript">
        /*<![CDATA[*/
        const paymentKey = /*[[${paymentKey}]]*/ '';
        const orderId = /*[[${orderId}]]*/ '';
        const amount = /*[[${amount}]]*/ 0;

        async function confirmPayment() {
            try {
                const response = await fetch("/confirm", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({
                        paymentKey: paymentKey,
                        orderId: orderId,
                        amount: amount.toString()
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    window.location.href = `/order/fail?message=${encodeURIComponent(errorData.message)}&code=${encodeURIComponent(errorData.code)}`;
                    return;
                }

                const result = await response.json();
                console.log("Payment confirmed:", result);
                
            } catch (error) {
                console.error("Payment confirmation error:", error);
                window.location.href = `/order/fail?message=${encodeURIComponent(error.message)}&code=ERROR`;
            }
        }

        // 페이지 로드 시 결제 확인
        window.addEventListener('DOMContentLoaded', confirmPayment);
        /*]]>*/
    </script>
</div>
</html>
